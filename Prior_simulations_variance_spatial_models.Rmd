---
title: "Prior Simulations for status and trend models"
author: "Adam C. Smith"
date: "30/03/2023"
output: pdf_document
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, message=FALSE,echo=FALSE,error=TRUE}
options(scipen=99999)
library(tidyverse)
library(cmdstanr)
library(mgcv) 
library(patchwork)
library(kableExtra)
library(bbsBayes)

tb_sims <- data.frame(model = c(rep("gamye",2),
                                rep("first_difference",3)),
                      spatial = c(FALSE,TRUE,
                                  FALSE,FALSE,TRUE),
                      hierarchical = c(TRUE,TRUE,
                                       FALSE,TRUE,TRUE),
                      model_file = c("gamye_non_spatial_prior_sim.stan",
                                "gamye_spatial_prior_sim.stan",
                                "first_difference_non_hierarchical_prior_sim.stan",
                                "first_difference_non_spatial_prior_sim.stan",
                                "first_difference_spatial_prior_sim.stan"),
                      prior_time = c(1,1,
                                    NA,0.1,0.1),
                      prior_sd_time = c(1,1,
                                        0.2,0.2,0.2),
                      prior_yeareffects = c(10,10,
                                        NA,NA,NA))

```

# Priors

Priors for standard deviations ($\sigma$) were generally weakly informative, half standard t-distributions with 3 degrees of freedom (e.g., $\sigma_\theta \sim \left\|t(3,0,1)\right\|$ ), which encompass the range of plausible values given the log-scale models.
However, some priors on the standard deviations were set to provide a regularizing effect to help constrain the parameters to reasonable values when the data were sparse.
For example, we set the priors for the standard deviations of the among observer variation in the BBS model so that 95% of the prior mass was \< 1.0 ( $\sigma_\omega \sim \left|normal(0,0.3)\right|$ ).
This somewhat informative prior is reasonable in that it suggests that more than a 2-fold variation in mean counts among observers is relatively rare (i.e., 95% of observers mean counts will fall somewhere between half as many and twice as many birds as an average observer, all else being equal).

We used a prior simulation to establish weakly informative and meaningful priors for the scale of the spline coefficients in the GAMYE ( $\sigma_{B_i^{\prime}}$ and $\sigma_{B_i^{\prime\prime}}$ ) and the annual difference parameters in the first-difference models ($\sigma_{\pi_i^{\prime}}$ and $\sigma_{\pi_i^{\prime\prime}}$).

# Prior Simulation of parameters that control the population trajectories in spatial status and trend models

Our overall goal was to demonstrate some weakly informative priors for the status and trend models based on the realised trend estimates from \>50 years of monitoring data from two North American bird monitoring programs, the North American Breeding Bird Survey (BBS) and the Christmas Bird Count (CBC).
Conceptually, our goal is to define priors for population status and trend models that reflect our current knowledge about the rates of change and variation in rates of change for bird populations in North America.
For omnibus models applied to multi-species surveys like the CBC, BBS, and Shorebird migration monitoring, we suggest that priors with a weak regularizing effect are preferable to priors that imply more temporal and spatial variation.

1.  The weakly informative and mildly regularising priors reflect two explicit assumptions:\
    that rates of population change and variation in those rates for any given species are very likely to fall somewhere within the range of comparable parameter estimates for past data from all of the other species in similar monitoring programs.

2.  That extreme trends and extreme levels of variation in trends are particularly unlikely without comparably strong evidence to support those extreme values.

These simulations demonstrate the distribution of predictions from these models when there are no data.
Given the broad spatial and temporal scale of these monitoring programs and the 1000s - 100,000s of observations for any given species, these priors are primarily relevant in the most data-sparse regions or time-periods for any given species.

## Methods overview

Using the published annual indices of relative abundance (i.e., the population trajectories) published by the USGS and Audubon, we can generate reasonable estimates of the realised distributions for some key population parameters for North American birds.
Together, these two programs estimate population trajectories and trends for \> 600 species of birds.
Using these population trajectories we estimated trends in populations at two spatial scales: province/state and survey-wide scales.
We estimated the spatial variation in the trends by estimating the standard deviation of province/state trends within species.
We estimated these trends and spatial variation in trends for a range of temporal scales, including 1-year annual fluctuations, short-term trends, and long-term trends.

We then compared prior predictions of trends from our status and trend models with the realised distributions of trends and variation in trends.
These comparisons allow us to choose weakly informative priors for the status and trend models that are sufficiently flexible to cover most of the observed variation in trajectories without including significant prior probability for implausible rates of population change or spatial variations in those rates.
Specifically, we use these simulations to set priors on the spline parameters and annual fluctuations in the GAMYE, annual differences in the first-difference model, and the variation among regions in these same parameters (both spatially explicit and non-spatial versions).

```{r load saved figures, echo=FALSE}

sd_overview <- readRDS("output/sd_overview.rds")
sw_overview <- readRDS("output/survey_wide_overview.rds")
sp_overview <- readRDS("output/state_province_overview.rds")


```

## Simulation summary

For both the spatial and non-spatial GAMYE models, we used the following priors for the hyperparameters that control the mean overall smooth and the year-effects (random annual fluctuations around the smooth) within each stratum:

-   standard deviation of the spline parameters that govern the shape and flexibility of the overall mean smooth = $\sigma_{B_i^{\prime}} \sim \left|t(3,0,1)\right|$.

-   standard deviation of the year-effects in a given stratum = $\sigma_{\gamma_i} \sim Gamma(2,10)$.
    This is a boundary avoiding prior that puts 95% of the prior mass at values less than 0.5, annual fluctuations greater than \~50% are unlikely, but the long tail allows for much larger values when supported by the data.

For the spatial GAMYE, to control the variation in the shape of the smooth component of the population trajectory in each region:

-   standard deviation for a given knot in the basis function controlling the variation among regions = $\sigma_{B_i^{\prime\prime}} \sim \left|normal(0,1)\right|$.

For the non-spatial GAMYE, to control the variation in the shape of the smooth component of the population trajectory in each region:

-   standard deviation of the collection of spline parameters in each region = $\sigma_{B_i^{\prime\prime}} \sim \left|normal(0,1)\right|$.

For the spatial and non-spatial first difference models, the standard deviation of the differences between subsequent years control the shape of the population trajectory.
We used the same priors in these two models:

-   standard deviation of the differences between years in the overall mean population trajectory = $\sigma_{\pi_i^{\prime}} \sim \left|t(3,0,1)\right|$.
    This prior suggests that it is unlikely that the average annual changes in the survey-wide (continental) population would be greater than 20%.

-   standard deviation of the among strata variation in the annual change in populations = $\sigma_{\pi_i^{\prime\prime}} \sim \left|normal(3,0,0.1)\right|$.
    This prior suggests that it is unlikely that the average among strata variation in annual population change would be greater than 40%.

For the non-hierarchical first difference model, population trajectories are estimated independently in each stratum, and there is no mean overall trajectory.
In this model only one parameter controls the shape of the population trajectory in a given stratum:

-   standard deviation of the differences between years in the population trajectory = $\sigma_{\pi_i^{\prime\prime}} \sim \left|normal(3,0,0.2)\right|$. This prior suggests that it is unlikely that the average annual changes in the stratum-level population would be greater than 40%.

These plots show the frequency distribution of prior predictions from the various models in coloured lines against the distribution of realised trend estimates from all species in both the BBS and CBC datasets, for all possible 1-year, 10-year, and 50-year periods in the datasets 1966-2019.
To simplify the displays and to account for any bias in the direction of the realised trends from the BBS and CBC, we converted all trends (prior predictions and realised values) to their absolute values.

```{r, echo=FALSE}
print(sw_overview)
```

The prior predictive distributions of the absolute value of survey-wide trends align closely with the realised distribution of absolute values of survey-wide trends for various time-scales.

```{r, echo=FALSE}
print(sp_overview)
```

The prior distributions of the absolute values of strata-level trends also align well with the realised trends.
The prior predictions for GAMYE models fit best for the 10 and 50-year trends and tend to suggest much more variation in the short-term.
Arguably, the priors for the scale of the year-effects may be too wide, because 1-year trends from the GAMYE generally include large amounts of prior mass at values greater than those commonly observed in the realised data.
By contrast, the first difference predictions align most closely with the 1-year trends and suggest that extreme values of long-term trends are less probable.

```{r, echo=FALSE, warning=FALSE}
print(sd_overview)
```

The prior distributions of the standard deviation of trends among regions for a given species generally don't

## Load all of the published BBS and CBC trends for the long-term

The USGS and Audubon publish trend estimates for the long-term, starting in the late 1960s.
We will use these long-term trend estimates for the regions and time-periods that they are available.

```{r trend load, eval=FALSE}

bbs_trends <- read.csv("data/BBS_1966-2019_core_best_trend.csv") %>% 
  filter(Region == "SU1" |
           !grepl(x = Region, pattern = "[[:digit:]]")) %>% # state level names do not have numbers, all others do
  mutate(Region = ifelse(Region == "SU1","Survey_Wide",Region),
         Survey = "BBS",
         AOU = as.character(AOU),
         se_trend = (X97.5.CI - X2.5.CI)/4) %>% 
  rename(trend = Trend)


cbc_trends <- read.csv("data/cbc_trends_abundance_indices_and_scaling_factors_v4.0_web_download_12Apr2022.csv") %>% 
  filter(grepl(pattern = "RatioTrendAllYears",parameter),
         (stratum == "USACAN" | 
            nchar(stratum) == 2)) %>% 
  select(ebird_com_name,stratum,estimate_mean,estimate_ucl,estimate_lcl,parameter) %>%  
  rename(AOU = ebird_com_name,
         Region = stratum,
         trend = estimate_mean) %>% 
  mutate(Region = ifelse(Region == "USACAN","Survey_Wide",Region),
         Survey = "CBC",
         se_trend = (estimate_ucl-estimate_lcl/4))



save(list = c("cbc_trends","bbs_trends"),
     file = "data/CBC_BBS_published_trends.RData")

```

To supplement these published trend estimates, we generated additional estimates of trends and variation in trends using the published population trajectories (collection of annual indices of relative abundance).
These additional estimates of trend are a post-hoc summary of the population trajectories that will not include any assessment of uncertainty.
For our purposes, the uncertainty of each additional trend estimate is much less important than the full collection of estimates across all time-periods, regions, and species.
Because we have ignored the uncertainty of the trajectories in our calculations of trends, we have also removed some of the extremely poorly estimated annual indices of abundance from each data collection.
We dropped all estimates of annual abundance that had a coefficient of variation \> 100 (SD/mean \> 100).

## Loading all of the published population trajectories for BBS and CBC

Estimates from the program area available at a number of different spatial scales, but for this analysis, we have selected the survey-wide estimates to represent the broadest species-level estimates, and the state/province estimates to represent the spatial variation within species because of their consistent treatment in the two programs.

```{r load trajectories,eval=FALSE}

## downloaded from https://www.mbr-pwrc.usgs.gov/ on June 13 2022
bbs_inds <- read.csv("data/Index_best_1966-2019_core_best.csv",
                             colClasses = c("integer",
                                            "character",
                                            "integer",
                                            "numeric",
                                            "numeric",
                                            "numeric")) %>% 
rename(lci = X2.5..CI,
       uci = X97.5..CI) %>% 
  mutate(cv = ((uci-lci)/4)/Index ) %>% 
  select(AOU,Region,Year,Index,cv) %>% 
  filter(Region == "SU1" |
           !grepl(x = Region, pattern = "[[:digit:]]")) %>% # state level names do not have numbers, all others do
  filter(cv < 100,
         !is.na(cv)) %>%  # drop extremely poorly estimated values
  mutate(Region = ifelse(Region == "SU1","Survey_Wide",Region),
         Survey = "BBS",
         AOU = as.character(AOU))


# provided by Audubon June 13 2022.
cbc_file <- "data/cbc_trends_abundance_indices_and_scaling_factors_v4.0_web_download_12Apr2022.csv"
cbc_inds <- read.csv(cbc_file) %>% 
  filter(parameter == "AbundanceIndex",
         (stratum == "USACAN" | 
            nchar(stratum) == 2)) %>% # selects the state/prov two-letter names
  mutate(cv = ((estimate_ucl-estimate_lcl)/4)/estimate_median ) %>% 
select(ebird_com_name,stratum,count_year,estimate_median,cv) %>%  
rename(AOU = ebird_com_name,
       Region = stratum,
       Year = count_year,
       Index = estimate_median) %>% 
  filter(cv < 100) %>%  # drop extremely poorly estimated values
  mutate(Region = ifelse(Region == "USACAN","Survey_Wide",Region),
         Survey = "CBC",
         Year = as.integer(Year))

all_inds <- bind_rows(bbs_inds,cbc_inds)

save(list = "all_inds",
     file = "data/all_state_survey_wide_indices_BBS_CBC.RData")

```

Using the trajectories, we calculate all possible 1-year, 2-year, 5-year, 10-year, 20-year trends, and 50-year trends with no uncertainty, just the point estimates based on the comparison of posterior medians of annual indices.
These trends are similar to the end-point trends used in the hierarchical models for the BBS and CBS.

```{r calculate_trends, eval=FALSE}

load("data/all_state_survey_wide_indices_BBS_CBC.RData")

# function to calculate a %/year trend from a count-scale trajectory
trs <- function(y1,y2,ny){
  tt <- (((y2/y1)^(1/ny))-1)*100
}

miny = min(all_inds$Year)
maxy = max(all_inds$Year)
all_trends <- NULL

for(tl in c(2,6,11,21,51)){ 
  #estimating all possible 1-year, 2-year, 5-year, 10-year, 20-year, 
  # and 50-year trends, with no uncertainty, just the point estimates 
  #based on the comparison of posterior means fo annual indices
  ny = tl-1
  yrs1 <- seq(miny,(maxy-ny),by = 1)
  yrs2 <- yrs1+ny
  for(j in 1:length(yrs1)){
    y2 <- yrs2[j]
    y1 <- yrs1[j]
    
    nyh2 <- paste0("Y",y2)
    nyh1 <- paste0("Y",y1)
    
    tmp <- all_inds %>% 
      filter(Year %in% c(y1,y2)) %>% 
      select(AOU,Index,Year,Region,Survey) %>% 
      pivot_wider(.,names_from = Year,
                  values_from = Index,
                  names_prefix = "Y") %>%
      rename_with(.,~gsub(pattern = nyh2,replacement = "YE", .x)) %>% 
      rename_with(.,~gsub(pattern = nyh1,replacement = "YS", .x)) %>% 
      drop_na() %>% 
      group_by(AOU,Region,Survey) %>% 
      summarise(trend = trs(YS,YE,ny),
                .groups = "keep")%>% 
      mutate(first_year = y1,
             last_year = y2,
             nyears = ny,
             abs_trend = abs(trend),
             t_years = paste0(ny,"-year trends"))
    
    all_trends <- bind_rows(all_trends,tmp)
  }
}



  load("data/CBC_BBS_published_trends.RData")

 
  
  bbs_trends <- bbs_trends %>%
    rename(trend = Trend) %>% 
    mutate(abs_trend = abs(trend),
           t_years = "50-year trends",
           Survey = "BBS_Pub",
           AOU = as.character(AOU)) %>% 
    select(abs_trend,trend,Region,AOU,Survey,t_years)
  cbc_trends <- cbc_trends %>%
    rename(trend = Trend) %>%  
    mutate(abs_trend = abs(trend),
           t_years = "50-year trends",
           Survey = "CBC_Pub") %>% 
    select(abs_trend,trend,Region,AOU,Survey,t_years)
  
  all_trends <- all_trends %>% 
    bind_rows(.,bbs_trends) %>% 
    bind_rows(.,cbc_trends) %>% 
  mutate(t_years = factor(t_years,
                          levels = c("1-year trends",
                                     "5-year trends",
                                     "10-year trends",
                                     "20-year trends",
                                     "50-year trends"),
                          ordered = TRUE))

  saveRDS(all_trends,file = "data/all_trends_bbs_cbc.rds")

```

## Realised distribution of all trend estimates from CBC and BBS

The distribution of survey wide trend estimates for CBC and BBS data.

```{r plotting all sw trends}

all_trends <- readRDS("data/all_trends_bbs_cbc.rds")
all_continental_trends <- all_trends %>% 
  filter(Region == "Survey_Wide")
mxabs = 2000#quantile(all_trends$abs_trend,0.9999) - facilitates setting breaks


realised_all_sw_freq <- ggplot(data = all_continental_trends,
                                 aes(abs_trend,after_stat(density),
                                     group = Survey,
                                        colour = Survey))+
  geom_freqpoly(breaks = c(0,seq(0.5,mxabs,0.5)),center = 0)+
  xlab("Absolute value of survey-wide trends USGS and Audubon models (1966-2019)")+
  ylab("")+
  theme_bw()+
  coord_cartesian(ylim = c(0,0.7),
                  xlim = c(0,40))+
  facet_wrap(vars(t_years),
             nrow = 1,
             ncol = 5)
print(realised_all_sw_freq)

```

The realised distribution of all state/provincial trend estimates for BBS and CBC.

```{r plotting trends by stateprov}



#selecting the province/state level trends to assess spatial variation
all_politic_trends <- all_trends %>% 
  filter(Region != "Survey_Wide")



realised_all_politic_freq <- ggplot(data = all_politic_trends,
                                 aes(abs_trend,after_stat(density),
                                     group = Survey,
                                        colour = Survey))+
  geom_freqpoly(breaks = c(0,seq(0.5,mxabs,0.5)),center = 0)+
  xlab("Absolute value of state/province trends USGS and Audubon models")+
  ylab("")+
  theme_bw()+
  coord_cartesian(ylim = c(0,0.7),
                  xlim = c(0,40))+
  facet_wrap(vars(t_years),
             nrow = 1,
             ncol = 5)
print(realised_all_politic_freq)

```

## Examining the variation among regions within a given species

The published estimates of trends can also inform our prior expectations on the variation among regions in population trends at different temporal scales.

```{r calculate variation in trends}
all_sd_trends <- all_politic_trends %>%
  filter(!(t_years == "1-year trends" & Survey == "CBC"),
         t_years != "5-year trends") %>% 
  group_by(AOU,t_years,Survey) %>% 
  summarise(sd_trends = sd(trend,na.rm = TRUE),
            min_trend = min(trend,na.rm = TRUE),
            max_trend = max(trend,na.rm = TRUE),
            q5_trend = quantile(trend,0.05,na.rm = TRUE),
            q95_trend = quantile(trend,0.95,na.rm = TRUE),
            .groups = "keep") %>% 
  filter(is.finite(sd_trends))

realised_all_sd <- ggplot(data = all_sd_trends,
                                    aes(sd_trends,after_stat(density),
                                        group = Survey,
                                        colour = Survey))+
  geom_freqpoly(breaks = c(0,seq(0.5,mxabs,0.5)),center = 0)+
  xlab("SD (by species) of state/province trends USGS and Audubon models (1966-2019)")+
  ylab("")+
  theme_bw()+
  coord_cartesian(ylim = c(0,0.7),
                  xlim = c(0,40))+
  facet_wrap(vars(t_years),
             nrow = 1,
             ncol = 5)
print(realised_all_sd)


```

## Prior Simulation for the flexibility of the overall population trajectories

In the first difference model, the parameter that controls the flexibility of the population trajectory has a relatively clear biological interpretation: the mean log-scale difference in abundance between two subsequent years.
We have explored a range of prior values and distributions, and we have found that a half t-distribution with df = 3 and scale = 0.1 fits the realised distribution of CBC and BBS absolute annual differences (1-year trends) very well.
This prior implies that most annual differences in relative abundance are \< 20-30%.
This prior has a slight regularizing effect on the long-term trends in comparison to the CBC data (outer grey line), but still includes long-term trends that imply some very large overall changes in population size over a 50-year period.
We used the same prior for both the spatial and non-spatial versions.
For the non-hierarchical version, we fit a slightly wider version of the half t-distribution with df=3 and scale = 0.2.

```{r load saved plots, echo=FALSE}
realised_all_politic_freq <- readRDS("output/realised_all_politic_freq.rds")
realised_all_sw_freq <- readRDS("output/realised_all_sw_freq.rds")
print(realised_all_sw_freq[[4]])
print(realised_all_sw_freq[[5]])
print(realised_all_sw_freq[[2]])

```

For the GAMYE, the parameter that controls the flexibility of the overall trajectory (magnitude of the overall change and the wiggliness of the trajectory) is the standard deviation of the spline parameters.
This SD parameter controls the scale and variation of the parameters that link the spline basis function to the estimated smooth population trajectorye ([@crainiceanu2005; @bÃ¼rkner2017; @goodrich2020]). The semi-parametric nature of spline smooths and the variation among alternative basis functions complicates the use of default or informative priors ([@lemoine2019; @banner2020]).
We have explored a range of prior values and have found that a half t-distribution with 3 degrees of freedom (so heavy tailed) with a scale parameter = 1, fits the realised distributions of both long and short-term trends for most bird species surveyed by the BBS and the CBC.
It includes long tails that cover the range of plausible trend estimates without including large amounts of prior probability mass at implausibly extreme values.

### gamye non spatial

The survey wide trends, both full trajectory and the smooth only, from the gamye non-spatial model using half t-distribution with 0 mean, sd = `r tb_sims[1,"prior_time"]`, and 3 degrees of freedom for the standard deviation of the spline parameters that control the wiggliness of the mean population smooth, and a standard normal prior for wiggliness of the strata-level smooths.
The standard deviation of the year-effects were given a gamma prior with shape parameter = 2 and scale parameter = `r tb_sims[1,"prior_yeareffects"]`.

```{r gamye plot 1a, echo=FALSE}
realised_all_politic_freq <- readRDS("output/realised_all_politic_freq.rds")
realised_all_sw_freq <- readRDS("output/realised_all_sw_freq.rds")

print(realised_all_sw_freq[[1]])
```

```{r gamye plot 1b, echo=FALSE}
print(realised_all_politic_freq[[1]])
```

\newpage

### gamye spatial

The survey wide trends, both full trajectory and the smooth only, from the spatial version of the gamye model using half t-distribution with 0 mean, sd = `r tb_sims[2,"prior_time"]`, and 3 degrees of freedom for the standard deviation of the spline parameters that control the wiggliness of the mean population smooth, and a standard normal prior for the spatial variation among strata on the spline parameters.
The standard deviation of the year-effects were given a gamma prior with shape parameter = 2 and scale parameter = `r tb_sims[2,"prior_yeareffects"]`.

```{r gamye plot 2a, echo=FALSE}
print(realised_all_sw_freq[[2]])
```

```{r gamye plot 2b, echo=FALSE}
print(realised_all_politic_freq[[2]])
```

\newpage

### first difference non hierarchical

The survey wide trends, from the non hierarchical version of the first difference model using half t-distribution with 0 mean, sd = `r tb_sims[3,"prior_sd_time"]`, and 3 degrees of freedom for the standard deviation of the annual differences in abundance in a given stratum.

```{r gamye plot 3a, echo=FALSE}
print(realised_all_sw_freq[[3]])
```

```{r gamye plot 3b, echo=FALSE}
print(realised_all_politic_freq[[3]])
```

\newpage

### first difference non spatial

The survey wide trends, from the non spatial version of the first difference model using half t-distribution with 0 mean, sd = `r tb_sims[4,"prior_time"]`, and 3 degrees of freedom for the standard deviation of the mean overall annual differences in abundance, and a half t-distribution with a sd = `r tb_sims[4,"prior_sd_time"]` on the variation among strata in the differences.

```{r gamye plot 4a, echo=FALSE}
print(realised_all_sw_freq[[4]])
```

```{r gamye plot 4b, echo=FALSE}
print(realised_all_politic_freq[[4]])
```

\newpage

### first difference non spatial

The survey wide trends, from the non spatial version of the first difference model using half t-distribution with 0 mean, sd = `r tb_sims[5,"prior_time"]`, and 3 degrees of freedom for the standard deviation of the mean overall annual differences in abundance, and a half t-distribution with a sd = `r tb_sims[5,"prior_sd_time"]` on the spatial variation among strata on the differences.

```{r gamye plot 5a, echo=FALSE}
print(realised_all_sw_freq[[5]])
```

```{r gamye plot 5b, echo=FALSE}
print(realised_all_politic_freq[[5]])
```

\newpage

## Simulating the prior distributions

### Setting up the basic data structure using Wood Thrush

```{r simulated_condictions, include=FALSE, echo=FALSE}

tb_sims <- data.frame(model = c(rep("gamye",2),
                                rep("first_difference",3)),
                      spatial = c(FALSE,TRUE,
                                  FALSE,FALSE,TRUE),
                      hierarchical = c(TRUE,TRUE,
                                       FALSE,TRUE,TRUE),
                      model_file = c("gamye_non_spatial_prior_sim.stan",
                                "gamye_spatial_prior_sim.stan",
                                "first_difference_non_hierarchical_prior_sim.stan",
                                "first_difference_non_spatial_prior_sim.stan",
                                "first_difference_spatial_prior_sim.stan"),
                      prior_time = c(1,1,
                                    NA,0.1,0.1),
                      prior_sd_time = c(1,1,
                                        0.2,0.2,0.2),
                      prior_yeareffects = c(10,10,
                                        NA,NA,NA))


strat_data <- bbsBayes::stratify(by = "bbs_usgs")
# source("functions/prepare-data-Stan.R") # overwrites the bbsBayes prepare_data function

base_data <- bbsBayes::prepare_data(strat_data,
                         species_to_run = "Wood Thrush",
                         model = "gamye",
                         min_n_routes = 1,
                         basis = "mgcv")

strat_df <- data.frame(strat = base_data$strat,
                       strat_name = base_data$strat_name,
                       ST_12 = base_data$strat_name) %>% 
  distinct()
source("functions/neighbours_define.R")

strat_map <- bbsBayes::load_map("bbs_usgs") %>% 
  inner_join(.,strat_df,by = "ST_12")

strat_neighbours <- neighbours_define(strat_map,
                                      species = "simulated",
                                      plot_dir = "maps/",
                                      strat_indicator = "strat")

 
    nstrata = max(strat_df$strat)
      nyears = max(base_data$ymax)
      nyears_m1 = nyears-1
      midyear = floor(nyears/2)
  
      N_edges = strat_neighbours$N_edges
      node1 = strat_neighbours$node1
      node2 = strat_neighbours$node2
      
      Iy1 = c((midyear-1):1)
      Iy2 = c((midyear+1):nyears)
      nIy1 = length(Iy1)
      nIy2 = length(Iy2)
      
      nknots_year <- base_data$nknots
      year_basis <- base_data$X.basis

data_gamye <- list(
        nstrata = nstrata,
        nyears = nyears,
        nyears_m1 = nyears_m1,
        
        #spatial structure
        N_edges = N_edges,
        node1 = node1,
        node2 = node2,
        
        # gam parameters
        nknots_year = nknots_year,
        year_basis = year_basis,
                
        pnorm = 1, #sd prior for among strata trend is half t-distribution instead of half-normal (if pnorm == 1)

        df = 3 #prior is half t-distribution with this df
  
)

data_diff <- list(
        nstrata = nstrata,
        nyears = nyears,
        nyears_m1 = nyears_m1,
        
        #spatial structure
        N_edges = N_edges,
        node1 = node1,
        node2 = node2,
        
        #temporal indexing
        midyear =  midyear,
        Iy1 = Iy1,
        Iy2 = Iy2,
        nIy1 = nIy1,
        nIy2 = nIy2,
        
        #vector of zeros to fill midyear beta values
        zero_betas = rep(0,nstrata),
        
        pnorm = 1, #sd prior for among strata trend is half t-distribution instead of half-normal (if pnorm == 1)
        df = 3 #prior is half t-distribution with this df
  
)


```

### Fitting the prior models

```{r simulations,eval=FALSE}

for(i in 1:nrow(tb_sims)){
  mod <- tb_sims[i,"model"]
  prior_B <- tb_sims[i,"prior_time"]
  prior_b <- tb_sims[i,"prior_sd_time"]
  prior_y <- tb_sims[i,"prior_yeareffects"]
  
  if(mod == "gamye"){
    stan_data <- data_gamye
    stan_data[["prior_scale_y"]] <- prior_y
  
  }else{
    stan_data <- data_diff
    
  }
  
  stan_data[["prior_scale_b"]] <- prior_b
  
  if(tb_sims[i,"hierarchical"]){
    hier <- ""
    stan_data[["prior_scale_B"]] <- prior_B

    if(tb_sims[i,"spatial"]){
      spat <- "spatial"
      
    }else{
    spat <- "non_spatial"
      stan_data[["N_edges"]] <- NULL
      stan_data[["node1"]] <- NULL
      stan_data[["node2"]] <- NULL
      
    }
  
  }else{
    hier <- "non_hierarchical"
    spat <- ""
     stan_data[["N_edges"]] <- NULL
      stan_data[["node1"]] <- NULL
      stan_data[["node2"]] <- NULL
     
  }

  
  out_base <- paste("prior_sim",mod,spat,hier,sep = "_")
  

  mod_file <- paste0("models/",tb_sims[i,"model_file"])
        
      # Fit model ---------------------------------------------------------------
      
      print(paste("beginning",out_base,Sys.time()))
      
   
      ## compile model
      model <- cmdstan_model(mod_file)
      
      
      # Initial Values ----------------------------------------------------------
      
      
      # init_def <- function(){ list(sdbeta = runif(nyears_m1,0.01,0.1),
      #                              beta_raw = matrix(rnorm(nyears_m1*nstrata,0,0.01),nrow = nstrata,ncol = nyears_m1),
      #                              sdBETA = runif(1,0.01,0.1),
      #                              BETA_raw = rnorm(nyears_m1,0,0.01))}
      
      stanfit <- model$sample(
        data=stan_data,
        refresh=100,
        chains=2, iter_sampling=1000,
        iter_warmup=500,
        parallel_chains = 2,
        #pars = parms,
        adapt_delta = 0.8,
        max_treedepth = 10,
        seed = 123)
      
      
      stanfit$save_object(file = paste0("output/",out_base,".rds"))
      
      
      

      

}


```

We then summarized the estimated trajectories as well as the 1, 5, 10, 20, and 50-year trends simulated from the alternative priors.

```{r summarising,eval=FALSE}
source("Functions/posterior_summary_functions.R")

n_out <- NULL
trends_out <- NULL
summ_out <- NULL




for(i in 1:nrow(tb_sims)){
  
  trends_out_tmp <- NULL

  mod <- tb_sims[i,"model"]
  prior_B <- tb_sims[i,"prior_time"]
  prior_b <- tb_sims[i,"prior_sd_time"]
  prior_y <- tb_sims[i,"prior_yeareffects"]
  

  if(tb_sims[i,"hierarchical"]){
    hier <- ""

    if(tb_sims[i,"spatial"]){
      spat <- "spatial"
      
    }else{
    spat <- "non_spatial"

    }
  
  }else{
    hier <- "non_hierarchical"
    spat <- ""
  }

  
  out_base <- paste("prior_sim",mod,spat,hier,sep = "_")
  
  stanfit <- readRDS(paste0("output/",out_base,".rds"))


summ = stanfit$summary()

summ <- summ %>% 
  mutate(model = mod,
         spatial = spat,
         hierarchical = hier)

n_samples <- posterior_samples(stanfit,
                                 parm = "n",
                                 dims = c("strat","Year_Index"))


if(mod == "gamye"){
nsmooth_samples <- posterior_samples(stanfit,
                                 parm = "nsmooth",
                                 dims = c("strat","Year_Index"))
  

# N_samples <- posterior_samples(stanfit,
#                                  parm = "NSMOOTH",
#                                  dims = c("Year_Index"))

}





nyears = max(n_samples$Year_Index)
# function to calculate a %/year trend from a count-scale trajectory
trs <- function(y1,y2,ny){
  tt <- (((y2/y1)^(1/ny))-1)*100
}


for(tl in c(2,6,11,21,51)){ #estimating all possible 1-year, 10-year, and full trends
  ny = tl-1
  yrs1 <- seq(1,(nyears-ny),by = ny)
  yrs2 <- yrs1+ny
  for(j in 1:length(yrs1)){
    y2 <- yrs2[j]
    y1 <- yrs1[j]
    
nyh2 <- paste0("Y",y2)
nyh1 <- paste0("Y",y1)
trends <- n_samples %>% 
  filter(Year_Index %in% c(y1,y2)) %>% 
  select(.draw,.value,Year_Index,strat) %>% 
  group_by(.draw,Year_Index) %>% 
  summarise(.value = mean(.value),
            .groups = "keep") %>% 
  pivot_wider(.,names_from = Year_Index,
              values_from = .value,
              names_prefix = "Y") %>%
  rename_with(.,~gsub(pattern = nyh2,replacement = "YE", .x)) %>% 
  rename_with(.,~gsub(pattern = nyh1,replacement = "YS", .x)) %>% 
  group_by(.draw) %>% 
  summarise(trend = trs(YS,YE,ny),
            .groups = "keep")%>% 
  mutate(model = mod,
         spatial = spat,
         hierarchical = hier,
         first_year = y1,
         last_year = y2,
         nyears = ny,
         scale = "Survey_Wide",
         type = "full")



trends_out_tmp <- bind_rows(trends_out_tmp,trends)

trends <- n_samples %>% 
  filter(Year_Index %in% c(y1,y2)) %>% 
  select(.draw,.value,Year_Index,strat) %>% 
  pivot_wider(.,names_from = Year_Index,
              values_from = .value,
              names_prefix = "Y") %>%
  rename_with(.,~gsub(pattern = nyh2,replacement = "YE", .x)) %>% 
  rename_with(.,~gsub(pattern = nyh1,replacement = "YS", .x)) %>% 
  group_by(.draw,strat,
            .groups = "keep") %>% 
  summarise(trend = trs(YS,YE,ny),
            .groups = "keep")%>% 
  mutate(model = mod,
         spatial = spat,
         hierarchical = hier,
         first_year = y1,
         last_year = y2,
         nyears = ny,
         scale = "Regional",
         type = "full")

trends_out_tmp <- bind_rows(trends_out_tmp,trends)


if(mod == "gamye"){
  trends <- nsmooth_samples %>% 
  filter(Year_Index %in% c(y1,y2)) %>% 
  select(.draw,.value,Year_Index,strat) %>% 
  group_by(.draw,Year_Index) %>% 
  summarise(.value = mean(.value),
            .groups = "keep") %>% 
  pivot_wider(.,names_from = Year_Index,
              values_from = .value,
              names_prefix = "Y") %>%
  rename_with(.,~gsub(pattern = nyh2,replacement = "YE", .x)) %>% 
  rename_with(.,~gsub(pattern = nyh1,replacement = "YS", .x)) %>% 
  group_by(.draw) %>% 
  summarise(trend = trs(YS,YE,ny),
            .groups = "keep")%>% 
  mutate(model = mod,
         spatial = spat,
         hierarchical = hier,
         first_year = y1,
         last_year = y2,
         nyears = ny,
         scale = "Survey_Wide",
         type = "smooth")



trends_out_tmp <- bind_rows(trends_out_tmp,trends)

trends <- nsmooth_samples %>% 
  filter(Year_Index %in% c(y1,y2)) %>% 
  select(.draw,.value,Year_Index,strat) %>% 
  pivot_wider(.,names_from = Year_Index,
              values_from = .value,
              names_prefix = "Y") %>%
  rename_with(.,~gsub(pattern = nyh2,replacement = "YE", .x)) %>% 
  rename_with(.,~gsub(pattern = nyh1,replacement = "YS", .x)) %>% 
  group_by(.draw,strat) %>% 
  summarise(trend = trs(YS,YE,ny),
            .groups = "keep")%>% 
  mutate(model = mod,
         spatial = spat,
         hierarchical = hier,
         first_year = y1,
         last_year = y2,
         nyears = ny,
         scale = "Regional",
         type = "smooth")
trends_out_tmp <- bind_rows(trends_out_tmp,trends)


}

}
}
save(file = paste0("output/prior_sim_summary",out_base,".RData"),
     list = c("trends_out_tmp",
              "summ"))

summ_out <- bind_rows(summ_out,summ)
trends_out <- bind_rows(trends_out,trends_out_tmp)
  }#prior_scale

saveRDS(trends_out,file = "output/prior_sim_trends.rds")
saveRDS(summ_out,file = "output/prior_sim_summaries.rds")



```

```{r plotting_trends}

# loading the stored realised BBS and CBC trend estimates
 all_trends <- readRDS(file = "data/all_trends_bbs_cbc.rds")

all_sw_trends <- all_trends %>% 
  filter(Region == "Survey_Wide")
all_politic_trends <- all_trends %>% 
  filter(Region != "Survey_Wide")

mxabs = 2000#upper limit on the absolute trend estimates for the density plots below

## loading the prior simulated trends for all models
trends_out <- readRDS("output/prior_sim_trends.rds")


#summarising the trends for the political regions (not survey wide)
prior_trends_politic <- trends_out %>% 
  filter(scale != "Survey_Wide") %>% 
  mutate(abs_trend = abs(trend),
         t_years = paste(nyears,"year trends",sep = "-"),
         t_years = factor(t_years,
                          levels = c("1-year trends",
                                     "5-year trends",
                                     "10-year trends",
                                     "20-year trends",
                                     "50-year trends"),
                          ordered = TRUE),
         model_type = paste(model,spatial,hierarchical,sep = " "))

#setting up plotting label names for the models
mod_types <- unique(prior_trends_politic$model_type)
names(mod_types) <- gsub(mod_types,pattern = "(_)|[[:space:]]{2}",
                         replacement = " ")
realised_all_politic_freq <- vector(mode = "list",length = length(mod_types))
names(realised_all_politic_freq) <- mod_types

#looping through each model to generate the realised vs prior trend density plots
for(i in 1:length(mod_types)){
  mm = mod_types[i]
  mlab = names(mod_types)[i]

     tmp_sim <- prior_trends_politic %>% 
    filter(model_type == mm) 
  
tmp <- ggplot(data = all_politic_trends,
                                 aes(abs_trend,after_stat(density),
                                     groups = Survey))+
  geom_freqpoly(breaks = c(0,seq(0.5,mxabs,0.5)),center = 0,
              colour = grey(0.5))+
  geom_freqpoly(data = tmp_sim,
                aes(abs_trend,after_stat(density),
                colour = model_type),
                inherit.aes = FALSE,
                breaks = c(0,seq(0.5,mxabs,0.5)),center = 0)+
  scale_colour_viridis_d(begin = 0.8)+
  xlab("Absolute value of state/province trends USGS and Audubon models")+
  ylab("")+
  labs(title = paste0("Simulated state/province prior trends from ",mlab,"model"))+
  theme_bw()+
  theme(legend.position = "none")+
  coord_cartesian(ylim = c(0,0.7),
                  xlim = c(0,40))

  if(grepl(pattern = "gam",mm)){ # gamye models need to plots to represent the full and smooth only trend estimates
   tmp <- tmp+facet_wrap(vars(type,t_years),
             nrow = 2,ncol = 5)  
}else{
 tmp <- tmp+facet_wrap(vars(t_years),
             ncol = 5) 
}

realised_all_politic_freq[[mm]] <- tmp

}


# same plots and trend summaries as above, but for the survey-wide estimates
prior_trends_sw <- trends_out %>% 
  filter(scale == "Survey_Wide") %>% 
  mutate(abs_trend = abs(trend),
         t_years = paste(nyears,"year trends",sep = "-"),
         t_years = factor(t_years,
                          levels = c("1-year trends",
                                     "5-year trends",
                                     "10-year trends",
                                     "20-year trends",
                                     "50-year trends"),
                          ordered = TRUE),
         model_type = paste(model,spatial,hierarchical,sep = " "))

realised_all_sw_freq <- vector(mode = "list",length = length(mod_types))
names(realised_all_sw_freq) <- mod_types

# looping through models to generate plots
for(i in 1:length(mod_types)){
  mm = mod_types[i]
  mlab = names(mod_types)[i]
  tmp_sim <- prior_trends_sw %>% 
    filter(model_type == mm)
tmp <- ggplot(data = all_sw_trends,
                                 aes(abs_trend,after_stat(density),
                                     groups = Survey))+
  geom_freqpoly(breaks = c(0,seq(0.5,mxabs,0.5)),center = 0,
              colour = grey(0.5))+
  geom_freqpoly(data = tmp_sim,
                aes(abs_trend,after_stat(density),
                colour = model_type),
                inherit.aes = FALSE,
                breaks = c(0,seq(0.5,mxabs,0.5)),center = 0)+
  scale_colour_viridis_d(begin = 0.8)+
  xlab("Absolute value of survey wide trends USGS and Audubon models")+
  ylab("")+
  labs(title = paste0("Simulated survey wide prior trends from ",mlab,"model"))+
  theme_bw()+
  theme(legend.position = "none")+
  coord_cartesian(ylim = c(0,0.7),
                  xlim = c(0,40))

  if(grepl(pattern = "gam",mm)){
   tmp <- tmp+facet_wrap(vars(type,t_years),
             nrow = 2,ncol = 5) 
 }else{
  tmp <- tmp+facet_wrap(vars(t_years),
             ncol = 5) 
}

realised_all_sw_freq[[mm]] <- tmp

}

saveRDS(realised_all_sw_freq,
        "output/realised_all_sw_freq.rds")

saveRDS(realised_all_politic_freq,
        "output/realised_all_politic_freq.rds")




```

The code above plots the realised distribution of trends across the full time series of the BBS and CBC (black lines) along with the distribution of trends using the various priors used in the models in this paper.

\newpage

```{r overview plots}

  tmp_sim <- prior_trends_sw %>% 
    filter(t_years %in% c("1-year trends",
                          "10-year trends",
                          "50-year trends"),
           type == "full") %>% 
  mutate(Model = gsub(model_type,
                      pattern = "_",
                      replacement = "-"))




sub_sw_trends <- all_sw_trends %>% 
    filter(t_years %in% c("1-year trends",
                          "10-year trends",
                          "50-year trends"))
sw_overview <- ggplot(data = sub_sw_trends,
                                 aes(abs_trend,after_stat(density)))+
    geom_histogram(breaks = c(0,seq(0.5,mxabs,0.5)),
              colour = grey(0.5))+
  geom_freqpoly(data = tmp_sim,
                aes(abs_trend,after_stat(density),
                colour = Model),
                inherit.aes = FALSE,
                breaks = c(0,seq(0.5,mxabs,0.5)),center = 0)+
  scale_colour_viridis_d(begin = 0.2)+
  xlab("Absolute value of survey wide trends")+
  ylab("")+
  labs(title = paste0("Simulated survey wide prior trends"))+
  theme_bw()+
  coord_cartesian(ylim = c(0,0.7),
                  xlim = c(0,40))+
  facet_wrap(vars(t_years),
             ncol = 5) 

sw_overview



saveRDS(tmp,
        "output/survey_wide_overview.rds")


  tmp_sim <- prior_trends_politic%>% 
    filter(t_years %in% c("1-year trends",
                          "10-year trends",
                          "50-year trends"),
           type == "full") %>% 
  mutate(Model = gsub(model_type,
                      pattern = "_",
                      replacement = "-"))
  
  

sub_politic_trends <- all_politic_trends %>% 
    filter(t_years %in% c("1-year trends",
                          "10-year trends",
                          "50-year trends"))

geo_overview <- ggplot(data = sub_politic_trends,
                                 aes(abs_trend,after_stat(density)))+
    geom_histogram(breaks = c(0,seq(0.5,mxabs,0.5)),
              colour = grey(0.5))+
  geom_freqpoly(data = tmp_sim,
                aes(abs_trend,after_stat(density),
                colour = Model),
                inherit.aes = FALSE,
                breaks = c(0,seq(0.5,mxabs,0.5)),center = 0)+
  scale_colour_viridis_d(begin = 0.2)+
  xlab("Absolute value of state/province trends")+
  ylab("")+
  labs(title = paste0("Simulated state/province prior trends"))+
  theme_bw()+
  coord_cartesian(ylim = c(0,0.7),
                  xlim = c(0,40))+
  facet_wrap(vars(t_years),
             ncol = 5) 

geo_overview





saveRDS(geo_overview,
        "output/state_province_overview.rds")



```

## Exploring the standard deviation of trends among regions

```{r sdtrends compile}

# loading the stored realised BBS and CBC trend estimates
 all_trends <- readRDS(file = "data/all_trends_bbs_cbc.rds")

all_sw_trends <- all_trends %>% 
  filter(Region == "Survey_Wide")
all_politic_trends <- all_trends %>% 
  filter(Region != "Survey_Wide")

realised_all_sd_freq <- vector(mode = "list",length = length(mod_types))
names(realised_all_sd_freq) <- mod_types

#function to calculate the inter-quartile interval
iq_func <- function(x,q = 0.5){
  q1 <- (1-q)/2
  q2 <- 1-q1
  iq <- quantile(x,q2) - quantile(x,q1)
  return(iq)
}

## summarizing the sd of realised trends
all_politic_sdtrends <- all_politic_trends %>% 
  filter(Survey %in% c("BBS","CBC")) %>% 
  group_by(Survey,AOU,first_year,last_year,nyears) %>% 
  summarise(sd_trend = sd(trend),
            iq_range = iq_func(trend)) %>% 
  mutate(t_years = paste(nyears,"year trends",sep = "-"),
         t_years = factor(t_years,
                          levels = c("1-year trends",
                                     "5-year trends",
                                     "10-year trends",
                                     "20-year trends",
                                     "50-year trends"),
                          ordered = TRUE)) 




## loading the prior simulated trends for all models
trends_out <- readRDS("output/prior_sim_trends.rds")

#summarising the trends for the political regions (not survey wide)
prior_sdtrends_politic <- trends_out %>% 
  filter(scale != "Survey_Wide") %>% 
  group_by(.draw,model,spatial,hierarchical,first_year,last_year,nyears,type) %>% 
  summarise(sd_trend = sd(trend),
            iq_range = iq_func(trend)) %>% 
  mutate(t_years = paste(nyears,"year trends",sep = "-"),
         t_years = factor(t_years,
                          levels = c("1-year trends",
                                     "5-year trends",
                                     "10-year trends",
                                     "20-year trends",
                                     "50-year trends"),
                          ordered = TRUE),
         model_type = paste(model,spatial,hierarchical,sep = " "))



# looping through models to generate plots
for(i in 1:length(mod_types)){
  mm = mod_types[i]
  mlab = names(mod_types)[i]
  tmp_sim <- prior_sdtrends_politic %>% 
    filter(model_type == mm)
tmp <- ggplot(data = all_politic_sdtrends,
                                 aes(sd_trend,after_stat(density),
                                     groups = Survey))+
  geom_freqpoly(breaks = c(seq(-mxabs,mxabs,0.5)),center = 0,
              colour = grey(0.5))+
  geom_freqpoly(data = tmp_sim,
    aes(sd_trend,after_stat(density),
    colour = model_type),
    inherit.aes = FALSE,
    breaks = c(seq(-mxabs,mxabs,0.5)),center = 0)+
  scale_colour_viridis_d(begin = 0.8)+
  xlab("SD of survey wide trends USGS and Audubon models")+
  ylab("")+
  labs(title = paste0("SD of simulated survey wide prior trends from ",mlab,"model"))+
  theme_bw()+
  theme(legend.position = "none")+
  coord_cartesian(ylim = c(0,0.7),
                  xlim = c(0,40))

  if(grepl(pattern = "gam",mm)){
   tmp <- tmp+facet_wrap(vars(type,t_years),
             nrow = 2,ncol = 5) 
 }else{
  tmp <- tmp+facet_wrap(vars(t_years),
             ncol = 5) 
}

realised_all_sd_freq[[mm]] <- tmp

}

saveRDS(realised_all_sd_freq,
        "realised_all_sd_freq.rds")



## overview plot

 tmp_sim <- prior_sdtrends_politic %>% 
    filter(((type == "full" & model == "first_difference")|
              (type == "full" & model == "gamye")),
           t_years %in% c("1-year trends",
                          "10-year trends",
                          "50-year trends")) %>% 
   mutate(Model = gsub("_","-",model_type))
 
 sub_politic_sdtrends <- all_politic_sdtrends %>% 
      filter(t_years %in% c("1-year trends",
                          "10-year trends",
                          "50-year trends"))
sd_overview <- ggplot(data = sub_politic_sdtrends,
                                 aes(sd_trend,after_stat(density)))+
  geom_histogram(breaks = c(seq(0,mxabs,0.5)),
              colour = grey(0.5))+
  geom_freqpoly(data = tmp_sim,
    aes(sd_trend,after_stat(density),
    colour = Model),
    inherit.aes = FALSE,
    breaks = c(seq(0,mxabs,0.5)),center = 0)+
  scale_colour_viridis_d(begin = 0.2)+
  xlab("SD of survey wide trends")+
  ylab("")+
  labs(title = paste0("SD of simulated prior trends among regions"))+
  theme_bw()+
  coord_cartesian(ylim = c(0,0.7),
                  xlim = c(0,40))+
  facet_wrap(vars(t_years),
             ncol = 5) 

saveRDS(sd_overview,"sd_overview.rds")

```

The code above plots the realised distribution of the standard deviation of trends among regions within species for all possible time-windows across the full time series of the BBS and CBC (black lines) along with the distribution of standard deviation of trends from the various priors used in the models in this paper.

\newpage

### gamye non spatial

The survey wide trends, both full trajectory and the smooth only, from the gamye non-spatial model using half t-distribution with 0 mean, sd = `r tb_sims[1,"prior_time"]`, and 3 degrees of freedom for the standard deviation of the spline parameters that control the wiggliness of the mean population smooth, and the same prior for wiggliness of the strata-level smooths.
The standard deviation of the year-effects were given a gamma prior with shape parameter = 2 and scale parameter = `r tb_sims[1,"prior_yeareffects"]`.

```{r gamye sdplot 1a}
print(realised_all_sd_freq[[1]])
```

\newpage

### gamye spatial

The survey wide trends, both full trajectory and the smooth only, from the spatial version of the gamye model using half t-distribution with 0 mean, sd = `r tb_sims[2,"prior_time"]`, and 3 degrees of freedom for the standard deviation of the spline parameters that control the wiggliness of the mean population smooth, and the same prior for the spatial variation among strata on the spline parameters.
The standard deviation of the year-effects were given a gamma prior with shape parameter = 2 and scale parameter = `r tb_sims[2,"prior_yeareffects"]`.

```{r gamye sdplot 2a}
print(realised_all_sd_freq[[2]])
```

\newpage

### first difference non spatial

The survey wide trends, from the non spatial version of the first difference model using half t-distribution with 0 mean, sd = `r tb_sims[4,"prior_time"]`, and 3 degrees of freedom for the standard deviation of the mean overall annual differences in abundance, and a half t-distribution with a sd = `r tb_sims[4,"prior_sd_time"]` on the variation among strata in the differences.

```{r gamye sdplot 4a}
print(realised_all_sd_freq[[4]])
```

\newpage

### first difference non spatial

The survey wide trends, from the non spatial version of the first difference model using half t-distribution with 0 mean, sd = `r tb_sims[5,"prior_time"]`, and 3 degrees of freedom for the standard deviation of the mean overall annual differences in abundance, and a half t-distribution with a sd = `r tb_sims[5,"prior_sd_time"]` on the spatial variation among strata on the differences.

```{r gamye sdplot 5a}
print(realised_all_sd_freq[[5]])
```
