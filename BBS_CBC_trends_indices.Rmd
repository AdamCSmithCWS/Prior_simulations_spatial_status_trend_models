---
title: "Variation in BBS and CBC trends"
author: "Adam C. Smith"
date: "2022-11-15"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(patchwork)

```

# Overview - prior simulations for temporal paramters in status and trend models

Using the published annual indices of relative abundance (i.e., the population trajectories) published by the USGS and Audubon, we can generate reasonable estimates of the prior distributions for some key population parameters for North American birds. Together, these two programs estimate population trajectories and trends for > 500 species of birds. These population trajectories track temporal variation in populations, such as annual fluctuations, short-term trends and long-term trends. We can also estimate the spatial variation in the temporal variation by comparing the regional estimates within species, such as the standard deviation in magnitude and direction of annual fluctuations, short-term trends, and long-term trends. 

We then compare predicted population trajectories and trend estimates from our status and trend models and compare them with the published estimates of population parameters for these 500+ species. These comparisons allow us to choose weakly informative priors for the status and trend models that are sufficiently flexible to cover the observed variation in trajectories without including significant prior probability for implausible rates of population change or spatial variations in those rates. Specifically, we use these simulations to set priors on the spline parameters and annual fluctuations in the GAMYE, annual differences in the first-difference model, and the variation among regions in these same parameters (both spatially explicit and non-spatial versions). 


## Load all of the published BBS and CBC trends for the long-term

The USGS and Audubon publish trend estimates for the long-term, starting in the late 1960s. We will use these long-term trend estimates for the regions and time-periods that they are available. 
```{r trend load, eval=FALSE}

bbs_trends <- read.csv("data/BBS_1966-2019_core_best_trend.csv") %>% 
  filter(Region == "SU1" |
           !grepl(x = Region, pattern = "[[:digit:]]")) %>% # state level names do not have numbers, all others do
  mutate(Region = ifelse(Region == "SU1","Survey_Wide",Region),
         Survey = "BBS",
         AOU = as.character(AOU)) %>% 
  rename(trend = Trend)


cbc_trends <- read.csv("data/cbc_trends_abundance_indices_and_scaling_factors_v4.0_web_download_12Apr2022.csv") %>% 
  filter(grepl(pattern = "RatioTrendAllYears",parameter),
         (stratum == "USACAN" | 
            nchar(stratum) == 2)) %>% 
  select(ebird_com_name,stratum,estimate_mean,estimate_ucl,estimate_lcl,parameter) %>%  
  rename(AOU = ebird_com_name,
         Region = stratum,
         trend = estimate_mean) %>% 
  mutate(Region = ifelse(Region == "USACAN","Survey_Wide",Region),
         Survey = "CBC")


save(list = c("cbc_trends","bbs_trends"),
     file = "data/CBC_BBS_published_trends.RData")

```


To supplement these published trend estimates, we will generate additional estimates of trends and other relevant parameters using the published population trajectories (collection of annual indices of relative abundance). These additional estimates of trend are a post-hoc summary of the population trajectories that will not include any assessment of uncertainty. For our purposes, the uncertainty of each additional trend estimate is much less important than the full collection of estimates across all time-periods, regions, and species. Because we have ignored the uncertainty of the trajectories in our calculations of trends, we have also removed some of the extremely poorly estimated annual indices of abundance from each data collection. We dropped all estimates of annual abundance that had a coefficient of variation > 100 (SD/mean > 100). 


## Loading all of the published population trajectories for BBS and CBC

Estimates from the program area available at a number of different spatial scales, but for this analysis, we have selected the survey-wide estimates to represent the broadest species-level estimates, and the state/province estimates to represent the spatial variation within species because of their consistent treatment in the two programs.

```{r load trajectories,eval=FALSE}

## downloaded from https://www.mbr-pwrc.usgs.gov/ on June 13 2022
bbs_inds <- read.csv("data/Index_best_1966-2019_core_best.csv",
                             colClasses = c("integer",
                                            "character",
                                            "integer",
                                            "numeric",
                                            "numeric",
                                            "numeric")) %>% 
rename(lci = X2.5..CI,
       uci = X97.5..CI) %>% 
  mutate(cv = ((uci-lci)/4)/Index ) %>% 
  select(AOU,Region,Year,Index,cv) %>% 
  filter(Region == "SU1" |
           !grepl(x = Region, pattern = "[[:digit:]]")) %>% # state level names do not have numbers, all others do
  filter(cv < 100,
         !is.na(cv)) %>%  # drop extremely poorly estimated values
  mutate(Region = ifelse(Region == "SU1","Survey_Wide",Region),
         Survey = "BBS",
         AOU = as.character(AOU))


# provided by Tim Meehan in email June 13 2022.
cbc_inds <- read.csv("data/cbc_trends_abundance_indices_and_scaling_factors_v4.0_web_download_12Apr2022.csv") %>% 
  filter(parameter == "AbundanceIndex",
         (stratum == "USACAN" | 
            nchar(stratum) == 2)) %>% # selects the state province two-letter names
  mutate(cv = ((estimate_ucl-estimate_lcl)/4)/estimate_median ) %>% 
select(ebird_com_name,stratum,count_year,estimate_median,cv) %>%  
rename(AOU = ebird_com_name,
       Region = stratum,
       Year = count_year,
       Index = estimate_median) %>% 
  filter(cv < 100) %>%  # drop extremely poorly estimated values
  mutate(Region = ifelse(Region == "USACAN","Survey_Wide",Region),
         Survey = "CBC",
         Year = as.integer(Year))

all_inds <- bind_rows(bbs_inds,cbc_inds)

save(list = "all_inds",
     file = "data/all_state_survey_wide_indices_BBS_CBC.RData")

```


Using the trajectories, we calculate all possible 1-year, 2-year, 5-year, 10-year, 20-year trends, and 50-year trends with no uncertainty, just the point estimates based on the comparison of posterior medians of annual indices. These trends are comparable to the end-point trends used in the hierarchical models for the BBS and CBS. 

```{r calculate_trends, cache = TRUE,eval=FALSE}

load("data/all_state_survey_wide_indices_BBS_CBC.RData")

# function to calculate a %/year trend from a count-scale trajectory
trs <- function(y1,y2,ny){
  tt <- (((y2/y1)^(1/ny))-1)*100
}

miny = min(all_inds$Year)
maxy = max(all_inds$Year)
all_trends <- NULL

for(tl in c(2,6,11,21,51)){ #estimating all possible 1-year, 2-year, 5-year, 10-year, 20-year, and 50-year trends, with no uncertainty, just the point estimates based on the comparison of posterior means fo annual indices
  ny = tl-1
  yrs1 <- seq(miny,(maxy-ny),by = 1)
  yrs2 <- yrs1+ny
  for(j in 1:length(yrs1)){
    y2 <- yrs2[j]
    y1 <- yrs1[j]
    
    nyh2 <- paste0("Y",y2)
    nyh1 <- paste0("Y",y1)
    
    tmp <- all_inds %>% 
      filter(Year %in% c(y1,y2)) %>% 
      select(AOU,Index,Year,Region,Survey) %>% 
      pivot_wider(.,names_from = Year,
                  values_from = Index,
                  names_prefix = "Y") %>%
      rename_with(.,~gsub(pattern = nyh2,replacement = "YE", .x)) %>% 
      rename_with(.,~gsub(pattern = nyh1,replacement = "YS", .x)) %>% 
      drop_na() %>% 
      group_by(AOU,Region,Survey) %>% 
      summarise(trend = trs(YS,YE,ny),
                .groups = "keep")%>% 
      mutate(first_year = y1,
             last_year = y2,
             nyears = ny,
             abs_trend = abs(trend),
             t_years = paste0(ny,"-year trends"))
    
    all_trends <- bind_rows(all_trends,tmp)
  }
}



  load("data/CBC_BBS_published_trends.RData")

 
  
  bbs_trends <- bbs_trends %>%
    rename(trend = Trend) %>% 
    mutate(abs_trend = abs(trend),
           t_years = "50-year trends",
           Survey = "BBS_Pub",
           AOU = as.character(AOU)) %>% 
    select(abs_trend,trend,Region,AOU,Survey,t_years)
  cbc_trends <- cbc_trends %>%
    rename(trend = Trend) %>%  
    mutate(abs_trend = abs(trend),
           t_years = "50-year trends",
           Survey = "CBC_Pub") %>% 
    select(abs_trend,trend,Region,AOU,Survey,t_years)
  
  all_trends <- all_trends %>% 
    bind_rows(.,bbs_trends) %>% 
    bind_rows(.,cbc_trends) %>% 
  mutate(t_years = factor(t_years,
                          levels = c("1-year trends",
                                     "5-year trends",
                                     "10-year trends",
                                     "20-year trends",
                                     "50-year trends"),
                          ordered = TRUE))

  saveRDS(all_trends,file = "data/all_trends_bbs_cbc.rds")

```





```{r plotting trends by stateprov}


all_trends <- readRDS("data/all_trends_bbs_cbc.rds")
all_continental_trends <- all_trends %>% 
  filter(Region == "Survey_Wide")
all_politic_trends <- all_trends %>% 
  filter(Region != "Survey_Wide")

mxabs = 2000#quantile(all_trends$abs_trend,0.9999)

realised_all_politic_freq <- ggplot(data = all_politic_trends,
                                 aes(abs_trend,after_stat(density),
                                     group = Survey,
                                        colour = Survey))+
  geom_freqpoly(breaks = c(0,seq(0.5,mxabs,0.5)),center = 0)+
  xlab("Absolute value of state/province trends USGS and Audubon models")+
  ylab("")+
  theme_bw()+
  coord_cartesian(ylim = c(0,0.7),
                  xlim = c(0,40))+
  facet_wrap(vars(t_years),
             nrow = 1,
             ncol = 5)
print(realised_all_politic_freq)

```


```{r plotting all sw trends}

realised_all_sw_freq <- ggplot(data = all_continental_trends,
                                 aes(abs_trend,after_stat(density),
                                     group = Survey,
                                        colour = Survey))+
  geom_freqpoly(breaks = c(0,seq(0.5,mxabs,0.5)),center = 0)+
  xlab("Absolute value of survey-wide trends USGS and Audubon models (1966-2019)")+
  ylab("")+
  theme_bw()+
  coord_cartesian(ylim = c(0,0.7),
                  xlim = c(0,40))+
  facet_wrap(vars(t_years),
             nrow = 1,
             ncol = 5)
print(realised_all_sw_freq)

```


```{r calculate variation in trends}
all_sd_trends <- all_politic_trends %>%
  filter(!(t_years == "1-year trends" & Survey == "CBC"),
         t_years != "5-year trends") %>% 
  group_by(AOU,t_years,Survey) %>% 
  summarise(sd_trends = sd(trend,na.rm = TRUE),
            min_trend = min(trend,na.rm = TRUE),
            max_trend = max(trend,na.rm = TRUE),
            q5_trend = quantile(trend,0.05,na.rm = TRUE),
            q95_trend = quantile(trend,0.95,na.rm = TRUE),
            .groups = "keep") %>% 
  filter(is.finite(sd_trends))

realised_all_sd <- ggplot(data = all_sd_trends,
                                    aes(sd_trends,after_stat(density),
                                        group = Survey,
                                        colour = Survey))+
  geom_freqpoly(breaks = c(0,seq(0.5,mxabs,0.5)),center = 0)+
  xlab("SD (by species) of state/province trends USGS and Audubon models (1966-2019)")+
  ylab("")+
  theme_bw()+
  coord_cartesian(ylim = c(0,0.7),
                  xlim = c(0,40))+
  facet_wrap(vars(t_years),
             nrow = 1,
             ncol = 5)
print(realised_all_sd)


```



